<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Movies — Popcorn Picks</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#0b0b0c;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
}
a{text-decoration:none;color:inherit}

.top{
  position:sticky;top:0;
  display:flex;justify-content:space-between;align-items:center;
  padding:16px 20px;
  background:rgba(10,10,10,.88);
  backdrop-filter:blur(10px);
  border-bottom:1px solid #222;
  z-index:50;
}
.top b{font-size:16px}

.wrap{padding:18px 18px 8px}
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.search{
  flex:1;
  min-width:240px;
  display:flex;
  gap:10px;
}
.search input{
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #222;
  background:#111;
  color:#fff;
  outline:none;
}
.btn{
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #222;
  background:#141414;
  color:#fff;
  cursor:pointer;
}
.btn:active{transform:translateY(1px)}
.small{
  color:#aaa;
  font-size:12px;
  padding:10px 2px 0;
}

.chips{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.chip{
  border:1px solid #222;
  background:#111;
  color:#ddd;
  padding:10px 12px;
  border-radius:999px;
  font-size:13px;
  cursor:pointer;
  user-select:none;
}
.chip.on{
  border-color:#444;
  background:#1b1b1b;
  color:#fff;
}

.grid{
  padding:16px 18px 26px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:18px;
}

.card{
  border-radius:18px;
  border:1px solid #181818;
  overflow:hidden;
  position:relative;
  background:#111;
  min-height:320px;
}
.poster{
  height:320px;
  background:#111;
  background-size:cover;
  background-position:center;
}
.info{
  position:absolute;
  bottom:0;left:0;right:0;
  padding:14px;
  background:linear-gradient(to top,rgba(0,0,0,.92),transparent);
}
.title{font-size:18px;font-weight:650;line-height:1.2}
.meta{font-size:12px;color:#aaa;margin-top:4px}
.tagsline{
  font-size:12px;
  color:#cfcfcf;
  margin-top:8px;
  opacity:.9;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.empty{
  padding:22px 18px 30px;
  color:#aaa;
}
</style>
</head>

<body>

<div class="top">
  <a href="index.html">← Home</a>
  <b>Movies</b>
  <span></span>
</div>

<div class="wrap">
  <div class="controls">
    <div class="search">
      <input id="q" type="text" placeholder="Search title, year, genre, country, vibe..." autocomplete="off" />
      <button class="btn" id="clearBtn" type="button">Clear</button>
    </div>
    <button class="btn" id="clearFiltersBtn" type="button">Clear filters</button>
  </div>

  <div class="small" id="resultCount">Loading...</div>
  <div class="chips" id="chips"></div>
</div>

<div class="grid" id="grid"></div>
<div class="empty" id="empty" style="display:none;">No matches. Try removing filters or changing the search.</div>

<script src="./moviesdata.js"></script>
<script>
  const grid = document.getElementById("grid");
  const chipsEl = document.getElementById("chips");
  const qEl = document.getElementById("q");
  const clearBtn = document.getElementById("clearBtn");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");
  const resultCount = document.getElementById("resultCount");
  const emptyEl = document.getElementById("empty");

  const fallbackPoster = "assets/home/movies.jpg";

  const MOVIES = Array.isArray(window.MOVIES) ? window.MOVIES : [];

  const picked = new Set();

  // Build a smart chip list: most common tags first, but keep it readable.
  function buildChips(movies){
    const counts = new Map();
    movies.forEach(m=>{
      (m.genres || []).forEach(t=>{
        const tag = String(t).trim();
        if(!tag) return;
        counts.set(tag, (counts.get(tag) || 0) + 1);
      });
    });

    // Choose top tags by frequency but also keep useful structure.
    // First, a curated priority list so important filters always show.
    const priority = [
      "India","Korea","Japan","China","Hong Kong","Germany","Brazil","Indonesia","USA","International",
      "Action","Crime","Thriller","Mystery","Drama","Horror","Sci-Fi","War","History","Biography","Romance","Comedy",
      "Neo-noir","Slow-burn","Psychological","Atmospheric","Stylish","Gritty","Mind-bending","Intense","Emotional",
      "Revenge","Investigation","Espionage","Courtroom","Survival","Siege","Chase","Dystopia","Folklore","Monster","Heist"
    ];

    // Put priority first if present, then remaining tags by count.
    const present = new Set([...counts.keys()]);
    const first = priority.filter(t => present.has(t));

    const rest = [...counts.entries()]
      .filter(([t]) => !priority.includes(t))
      .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]))
      .map(([t])=>t);

    // Limit chip count so UI stays clean.
    return [...first, ...rest].slice(0, 36);
  }

  function chipButton(tag){
    const b = document.createElement("div");
    b.className = "chip" + (picked.has(tag) ? " on" : "");
    b.textContent = tag;
    b.onclick = () => {
      if(picked.has(tag)) picked.delete(tag);
      else picked.add(tag);
      render();
      paintChips();
    };
    return b;
  }

  function paintChips(){
    chipsEl.innerHTML = "";
    const chipList = buildChips(MOVIES);
    chipList.forEach(tag => chipsEl.appendChild(chipButton(tag)));
  }

  function normalize(s){
    return String(s || "").toLowerCase().trim();
  }

  function matchesPicked(movie){
    if(picked.size === 0) return true;
    const tags = (movie.genres || []).map(x=>String(x));
    // Require ALL selected tags (AND). This feels cinephile and precise.
    for(const p of picked){
      if(!tags.includes(p)) return false;
    }
    return true;
  }

  function matchesQuery(movie, q){
    if(!q) return true;
    const hay = [
      movie.title,
      movie.year,
      movie.meta,
      (movie.genres || []).join(" "),
      movie.summary
    ].join(" ");
    return normalize(hay).includes(q);
  }

  function getSorted(movies){
    // Sort by year desc, then title asc
    return movies.slice().sort((a,b)=>{
      const ya = Number(a.year || 0);
      const yb = Number(b.year || 0);
      if(yb !== ya) return yb - ya;
      return String(a.title || "").localeCompare(String(b.title || ""));
    });
  }

  function card(movie){
    const a = document.createElement("a");
    a.className = "card";
    a.href = `movie.html?id=${encodeURIComponent(movie.id)}`;

    const poster = movie.poster ? movie.poster : fallbackPoster;
    const safePoster = String(poster).replace(/'/g, "\\'");

    const tagLine = (movie.genres || []).slice(0, 5).join(" • ");

    a.innerHTML = `
      <div class="poster" style="background-image:url('${safePoster}');"></div>
      <div class="info">
        <div class="title">${movie.title || "Untitled"}</div>
        <div class="meta">${movie.year || ""}${movie.meta ? " • " + movie.meta : ""}</div>
        <div class="tagsline">${tagLine}</div>
      </div>
    `;
    return a;
  }

  function render(){
    const q = normalize(qEl.value);
    const filtered = getSorted(
      MOVIES.filter(m => matchesPicked(m) && matchesQuery(m, q))
    );

    grid.innerHTML = "";
    filtered.forEach(m => grid.appendChild(card(m)));

    resultCount.textContent = `${filtered.length} title${filtered.length === 1 ? "" : "s"} found` +
      (picked.size ? ` • Filters: ${[...picked].join(", ")}` : "");

    emptyEl.style.display = filtered.length ? "none" : "block";
  }

  qEl.addEventListener("input", () => render());

  clearBtn.onclick = () => {
    qEl.value = "";
    render();
  };

  clearFiltersBtn.onclick = () => {
    picked.clear();
    render();
    paintChips();
  };

  // Initial
  paintChips();
  render();
</script>

</body>
</html>
